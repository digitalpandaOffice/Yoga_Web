<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Submission Successful - Edvayu Educational Foundations</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Montserrat:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="mainstyles.css">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body {
            background-color: #f9f9f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .success-container {
            max-width: 800px;
            margin: 60px auto;
            background: #fff;
            padding: 50px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #4CAF50;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 30px;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .success-title {
            font-family: 'Merriweather', serif;
            color: var(--deep-blue);
            font-size: 2.2rem;
            margin-bottom: 15px;
        }

        .success-message {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .ref-box {
            background: #f0f7ff;
            border: 2px dashed #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 40px;
            display: inline-block;
            min-width: 300px;
        }

        .ref-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .ref-number {
            color: #2196F3;
            font-size: 1.8rem;
            font-weight: 800;
            font-family: 'Montserrat', sans-serif;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .download-btn {
            padding: 15px 25px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--deep-blue);
            color: #fff;
        }

        .btn-primary:hover {
            background: #1a2c4e;
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--gold);
            color: var(--deep-blue);
        }

        .btn-secondary:hover {
            background: var(--terracotta);
            color: #fff;
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="top-banner" style="text-align: center; padding: 20px; background: #fff; border-bottom: 1px solid #eee;">
        <img src="./images/AdvayuLogo.png" alt="Logo" style="height: 60px;">
    </div>

    <div class="success-container">
        <div class="success-icon">‚úì</div>
        <h1 class="success-title">Application Submitted!</h1>
        <p class="success-message">
            Thank you for your interest in partnering with Edvayu Educational Foundations.
            Your application has been successfully received and is under review.
        </p>

        <div class="ref-box">
            <div class="ref-label">Temporary Reference No</div>
            <div class="ref-number" id="refDisplay">Loading...</div>
            <div id="statusMessage" style="font-size: 0.8rem; color: #777; margin-top: 5px;"></div>
        </div>

        <div class="action-buttons">
            <!-- Removed onclick, added ID -->
            <button id="downloadPdfBtn" class="download-btn btn-primary" disabled>
                <span>üìÑ</span> Download Submitted Form
            </button>
            <!-- Annexure Link -->
            <a href="assets/annexure_I_form.pdf" download class="download-btn btn-secondary"
                onclick="alert('Demo: Annexure PDF download started')">
                <span>üìé</span> Download Required Annexure I Form
            </a>
        </div>

        <div style="margin-top: 30px;">
            <a href="index.html" style="color: #666; text-decoration: underline;">Return to Home</a>
        </div>
    </div>

    <script>
        console.log('Success Page Script Loaded');

        let fetchedApplicationData = null;
        let currentRefNo = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Get Ref Number from URL
            const urlParams = new URLSearchParams(window.location.search);
            const refFromUrl = urlParams.get('ref');

            const refDisplay = document.getElementById('refDisplay');
            const statusMsg = document.getElementById('statusMessage');
            const downloadBtn = document.getElementById('downloadPdfBtn');

            if (!refFromUrl) {
                refDisplay.textContent = 'ERROR';
                statusMsg.textContent = 'No reference number found in URL.';
                return;
            }

            currentRefNo = refFromUrl;
            refDisplay.textContent = currentRefNo; // Show immediately
            statusMsg.textContent = 'Verifying application...';

            // 2. Fetch Data from Backend
            try {
                const response = await fetch(`http://localhost/Yoga_Web/Yoga_Backend/Franchise/get_application_data?ref=${currentRefNo}`);
                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    fetchedApplicationData = result.application.form_data;
                    statusMsg.textContent = 'Application confirmed. Ready to download.';
                    statusMsg.style.color = 'green';
                    downloadBtn.disabled = false; // Enable button
                    console.log('Data fetched successfully:', fetchedApplicationData);
                } else {
                    throw new Error(result.error || 'Application not found');
                }
            } catch (err) {
                console.error('Fetch Error:', err);
                statusMsg.textContent = 'Error: ' + err.message;
                statusMsg.style.color = 'red';
            }

            // 3. Attach PDF Download Listener
            if (downloadBtn) {
                downloadBtn.addEventListener('click', handlePdfDownload);
                console.log('PDF Download Listener Attached');
            }
        });

        // Main Handler Function
        async function handlePdfDownload() {
            const btn = document.getElementById('downloadPdfBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚è≥</span> Processing...';
            btn.disabled = true;

            try {
                if (typeof PDFLib === 'undefined') {
                    throw new Error("PDF Library failed to load. Please check your internet connection.");
                }

                // 1. Data Source: Use fetched data
                const data = fetchedApplicationData;
                if (!data) throw new Error("Application data not available. Please verify the Reference ID.");

                // 2. Load PDF Template
                const pdfUrl = 'http://localhost/Yoga_Web/Yoga_Backend/public/Documents/FranchiseFormDownloadFormat.pdf';
                console.log('Fetching PDF from:', pdfUrl);

                const existingPdfBytes = await fetch(pdfUrl).then(res => {
                    if (!res.ok) throw new Error(`Could not load PDF template from ${pdfUrl} (Status: ${res.status})`);
                    return res.arrayBuffer();
                });

                // 3. Interactive Form Filling
                // Destructure TextAlignment here
                const { PDFDocument, StandardFonts, TextAlignment } = PDFLib;
                const pdfDoc = await PDFDocument.load(existingPdfBytes);

                // Embed Helvetica to match document style
                const customFont = await pdfDoc.embedFont(StandardFonts.Helvetica);

                const form = pdfDoc.getForm();

                // DEBUG VERIFICATION:
                try {
                    const fields = form.getFields();
                    const fieldNames = fields.map(f => f.getName());
                    console.log('Detected Fields:', fieldNames);

                    if (fields.length === 0) {
                        alert("WARNING: The PDF file has no interactive form fields yet!\n\nPlease edit the PDF in Adobe Acrobat or LibreOffice to add fields named 'CentreName', 'OwnerName', etc.");
                    }
                } catch (e) { }

                // SAFE MAPPING HELPER
                const safeSet = (fieldName, value) => {
                    if (!value) return;
                    try {
                        const field = form.getField(fieldName);

                        if (field instanceof PDFLib.PDFCheckBox) {
                            if (value === 'Yes' || value === true || value === 'on') field.check();
                        } else if (field instanceof PDFLib.PDFTextField) {
                            // Apply formatting for Text Fields
                            field.setText(String(value));
                            field.setFontSize(10); // Standard Size
                            field.setAlignment(TextAlignment.Center); // CENTER TEXT
                            field.updateAppearances(customFont); // Apply Standard Helvetica
                        } else {
                            // Fallback
                            try { field.setText(String(value)); } catch (e) { }
                        }
                    } catch (e) {
                        // console.warn(`Field '${fieldName}' not found in PDF.`);
                    }
                };

                // --- DATA MAPPING START ---

                // 1. Centre Details
                safeSet('CentreName', data.centreName);
                safeSet('OwnerName', data.ownerName);
                safeSet('OwnerRelation', data.ownerRelation);
                safeSet('OwnerDOB', data.ownerDob);
                safeSet('CentreAddress', data.centreAddress);
                safeSet('OpeningDate', data.openingDate);
                safeSet('CentreArea', data.centreArea);
                safeSet('ToiletAvailable', data.toiletAvailable); // Yes/No
                safeSet('AuthorizationFor', data.authorizationFor);

                // 2. Faculty Details (Handling Arrays)
                const getArrayItem = (arr, index) => {
                    if (Array.isArray(arr)) return arr[index] || '';
                    if (index === 0 && arr) return arr;
                    return '';
                };

                for (let i = 0; i < 3; i++) {
                    const suffix = `_${i + 1}`; // _1, _2, _3
                    safeSet('FacultyName' + suffix, getArrayItem(data.facultyName, i));
                    safeSet('FacultyQual' + suffix, getArrayItem(data.facultyQual, i));
                    safeSet('FacultyExp' + suffix, getArrayItem(data.facultyExp, i));
                }

                // 3. Payment Details
                safeSet('AffiliationFee', data.affiliationFee);
                safeSet('PaymentDate', data.paymentDate);
                safeSet('PaymentMode', data.paymentMode);
                safeSet('TxnId', data.txnId);
                safeSet('Remarks', data.remarks);

                // 4. Submission Details (Section 1)
                safeSet('SubmissionDate', data.submissionDate);
                safeSet('Place', data.place);

                // 5. Centre Head Profile
                safeSet('ProfileName', data.profileName);
                safeSet('ProfileRelationName', data.profileRelationName);
                safeSet('ProfileDOB', data.profileDob);
                safeSet('Religion', data.religion);
                safeSet('Gender', data.gender);
                safeSet('Languages', data.languages);
                safeSet('PermanentAddress', data.permanentAddress);
                safeSet('Qualification', data.qualification);
                safeSet('ProfileExperience', data.experience);
                safeSet('Email', data.email);
                safeSet('ContactNumbers', data.contactNumbers);
                safeSet('Whatsapp', data.whatsapp);
                safeSet('AboutFamily', data.aboutFamily);

                // 6. Submission Details (Section 2)
                safeSet('SubmissionDateProfile', data.submissionDateProfile);
                safeSet('PlaceProfile', data.placeProfile);

                // --- DATA MAPPING END ---

                // Make PDF Read-Only (Flatten Form)
                try {
                    form.flatten();
                } catch (e) {
                    console.warn("Could not flatten form (fields might differ from expectations):", e);
                }

                // 4. Download
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Edvayu_Franchise_Form_${currentRefNo}.pdf`;
                link.click();

            } catch (error) {
                console.error('PDF Generation Error:', error);
                alert('Failed to generate PDF: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>